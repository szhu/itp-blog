<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      progress {
        transform: rotate(-90deg);
      }
      progress[value="90"] {
        opacity: 0.6;
      }
      :root:not([data-ble="connected"]) progress {
        opacity: 0.3;
      }
    </style>
  </head>
  <body>
    <center>
      <br />
      <br />
      <button
        id="connect"
        onclick="connectOrDisconnect(); event.stopPropagation();"
      >
        Connect!
      </button>
      <br />
      <progress id="motor1Speed" value="90" min="0" max="179">32%</progress>
      <progress id="motor2Speed" value="90" min="0" max="179">32%</progress>
    </center>
  </body>

  <script>
    let device = null;
    let seenDevices = new Set();
    let characteristic = null;

    const serviceUuid = "21e1aa31-b81f-4c3c-851c-72359b55f3db";

    const Events = {
      onConnected() {
        console.log("Connected");
        document.querySelector("#connect").textContent = "Disconnect";
        document.documentElement.dataset.ble = "connected";
      },
      onDisconnected() {
        console.log("Disconnected");
        document.querySelector("#connect").textContent = "Connect";
        document.documentElement.dataset.ble = "";
      },
    };

    async function connect() {
      device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [serviceUuid] }],
      });
      if (!seenDevices.has(device.id)) {
        device.addEventListener("gattserverdisconnected", () => {
          device = null;
          characteristic = null;
          currentOp = null;
          Events.onDisconnected();
        });
        seenDevices.add(device.id);
      }

      let server = await device.gatt.connect();
      let service = await server.getPrimaryService(serviceUuid);
      characteristic = await service.getCharacteristic(
        "114833ca-f1e2-4d0a-8fff-277881be1ddb"
      );
      Events.onConnected();
    }

    async function disconnect() {
      if (device) {
        await device.gatt.disconnect();
      }
    }

    async function connectOrDisconnect() {
      if (device) {
        await disconnect();
      } else {
        await connect();
      }
    }

    async function control(motor1Value, motor2Value, musicValue) {
      if (!characteristic) {
        return;
      }

      let value = 0n;
      value = value * 180n + BigInt(motor1Value);
      value = value * 180n + BigInt(motor2Value);
      value = value * 2n + BigInt(musicValue);
      await characteristic.writeValue(Uint16Array.of([value]));
    }

    let currentOp = undefined;
    document.body.addEventListener("mousemove", async (event) => {
      if (currentOp) {
        return;
      }

      function minMaxUnit(value) {
        return Math.min(Math.max(value, 0), 1);
      }

      function allowZeroArea(value) {
        let innerPadding = 0.3;
        let outerPadding = 0.2;
        let sign = value < 0 ? -1 : 1;
        let abs = Math.abs(value);
        let result =
          sign *
          minMaxUnit((abs - innerPadding) / (1 - innerPadding - outerPadding));
        return result;
      }

      let x = event.clientX;
      let y = event.clientY;
      let width = window.innerWidth;
      let height = window.innerHeight;
      let xRatio = allowZeroArea((x / width) * 2 - 1);
      let yRatio = allowZeroArea((y / height) * 2 - 1);

      let baseSpeed = -yRatio;
      let diff = xRatio;
      let motor1Speed = baseSpeed - diff;
      let motor2Speed = baseSpeed + diff;

      let motor1Value = Math.min(Math.floor(motor1Speed * 90 + 90), 179);
      let motor2Value = Math.min(Math.floor(motor2Speed * 90 + 90), 179);
      let musicValue = Math.abs(motor1Speed) + Math.abs(motor2Speed) < 0.2;

      document.querySelector("#motor1Speed").value = motor1Value;
      document.querySelector("#motor2Speed").value = motor2Value;
      currentOp = control(179 - motor1Value, motor2Value, musicValue);
      try {
        await currentOp;
      } catch (e) {
        currentOp = undefined;
        throw e;
      }
      currentOp = undefined;
    });
  </script>
</html>
